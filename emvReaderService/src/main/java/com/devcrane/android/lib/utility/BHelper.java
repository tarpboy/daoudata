package com.devcrane.android.lib.utility;import java.io.ByteArrayOutputStream;import java.io.File;import java.io.FileOutputStream;import java.io.PrintWriter;import java.io.StringWriter;import java.io.Writer;import java.security.MessageDigest;import java.text.NumberFormat;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Calendar;import java.util.List;import java.util.Locale;import android.annotation.SuppressLint;import android.app.Activity;import android.app.AlertDialog;import android.app.DatePickerDialog;import android.app.DatePickerDialog.OnDateSetListener;import android.app.TimePickerDialog;import android.app.TimePickerDialog.OnTimeSetListener;import android.content.Context;import android.content.DialogInterface;import android.content.pm.PackageManager;import android.content.pm.PackageManager.NameNotFoundException;import android.graphics.Bitmap;import android.graphics.Bitmap.CompressFormat;import android.graphics.BitmapFactory;import android.graphics.Typeface;import android.os.Build;import android.os.Environment;import android.os.Handler;import android.text.Editable;import android.text.InputFilter;import android.text.InputType;import android.text.TextWatcher;import android.util.Base64;import android.util.Log;import android.view.View;import android.view.View.OnClickListener;import android.view.ViewGroup;import android.view.inputmethod.InputMethodManager;import android.widget.Button;import android.widget.CheckBox;import android.widget.DatePicker;import android.widget.EditText;import android.widget.TextView;import android.widget.TimePicker;import android.widget.Toast;import com.devcrane.android.lib.emvreader.EmvApplication;public class BHelper {//	public static boolean TEST = false;		private static Context at;	public static void setContext(Context at) {		BHelper.at = at;	}		public static void setTypeface(View rootView) {		if (rootView == null) {			return;		}				List<View> visited = new ArrayList<View>();	    List<View> unvisited = new ArrayList<View>();	    unvisited.add(rootView);		    while (!unvisited.isEmpty()) {	        View child = unvisited.remove(0);	        visited.add(child);	        if (!(child instanceof ViewGroup)) continue;	        ViewGroup group = (ViewGroup) child;	        final int childCount = group.getChildCount();	        for (int i=0; i<childCount; i++) unvisited.add(group.getChildAt(i));	    }			Typeface tf = Typeface.createFromAsset(at.getAssets(), "fonts/RixGoB.ttf");	    for (View v : visited) {			if (v instanceof EditText) {				((EditText) v).setTypeface(tf);			} else if (v instanceof TextView) {				((TextView) v).setTypeface(tf);			} else if (v instanceof Button) {				((Button) v).setTypeface(tf);			} else if (v instanceof CheckBox) {				((CheckBox) v).setTypeface(tf);			}		}	}	private static String tag() {//		StackTraceElement[] elements = Thread.currentThread().getStackTrace();//		int position = 3;//		for (int i = 3; i < elements.length; i++) {//			if (!elements[i].getFileName().equals(BHelper.class.getSimpleName() + ".java")) {//				position = i;//				break;//			}//		}//		StackTraceElement element = elements[position];//		String className = element.getClassName();//		String tag = className.substring(className.lastIndexOf(".") + 1);		//		tag += "-" + element.getLineNumber();//		tag += "-" + element.getMethodName();//		tag += "-Binh";		return "Payfun";	}	public static void db(Object msg) {		if (msg == null) {			Log.w(tag(), "null.");			return;		}		if(EmvApplication.IS_ENABLE_LOG)			Log.i(tag(), msg.toString() + ".");	}				public static void ex(Exception ex) {//		Log.e(tag(), ex.getMessage());		final Writer result = new StringWriter();        final PrintWriter printWriter = new PrintWriter(result);        // Inject some info about android version and the device, since google can't provide them in the developer console        StackTraceElement[] trace = ex.getStackTrace();        StackTraceElement[] trace2 = new StackTraceElement[trace.length+3];        System.arraycopy(trace, 0, trace2, 0, trace.length);        trace2[trace.length+0] = new StackTraceElement("Android", "MODEL", android.os.Build.MODEL, -1);        trace2[trace.length+1] = new StackTraceElement("Android", "VERSION", android.os.Build.VERSION.RELEASE, -1);        trace2[trace.length+2] = new StackTraceElement("Android", "FINGERPRINT", android.os.Build.FINGERPRINT, -1);        ex.setStackTrace(trace2);        ex.printStackTrace(printWriter);        String stacktrace = result.toString();        printWriter.close();        Helper.writeLogFile(stacktrace);        ex.printStackTrace();	}	public static String moneyFormat(String number) {		try {			double numberformat = Double.valueOf(number);			return NumberFormat.getInstance(Locale.US).format(numberformat);		} catch (Exception ex) {			return "0";		}	}	public static String moneyParse(TextView tv) {		return tv.getText().toString().trim().replace(",", "");	}		public static void moneySet(final EditText txt, final Runnable runnable) {		txt.setInputType(InputType.TYPE_CLASS_NUMBER);		txt.setFilters(new InputFilter[] { new InputFilter.LengthFilter(18) });		txt.addTextChangedListener(new TextWatcher() {			@Override			public void onTextChanged(CharSequence s, int start, int before, int count) {}			@Override			public void beforeTextChanged(CharSequence s, int start, int count, int after) {}			@Override			public void afterTextChanged(Editable s) {				boolean b = s.toString().equals("");				double price = b ? 0 : Double.valueOf(s.toString().replace(",", ""));				String str = moneyFormat(String.valueOf(price));				txt.removeTextChangedListener(this);				txt.setText(str);				txt.setSelection(str.length());				txt.addTextChangedListener(this);				if (runnable != null)					runnable.run();			}		});	}	public static String fileSDCard(String dir) {//		File dirPath = Environment.getExternalStorageDirectory();		String dirPath = Environment.getExternalStorageDirectory() + "/"+dir;		File file = new File(dirPath);		if (!file.exists()) {			file.mkdirs();		}		return file + "/";	}	public static boolean fileRename(String oldPath, String newPath) {		final File file = new File(oldPath);		if (file.exists())			return file.renameTo(new File(newPath));		return false;	}		public static Bitmap bitmapFromFile(String fileName) {		Bitmap bm = BitmapFactory.decodeFile(fileName);		return bm;	}	public static String bitmapToBase64(Bitmap bm) {		ByteArrayOutputStream baos = new ByteArrayOutputStream();		bm.compress(Bitmap.CompressFormat.PNG, 100, baos);		byte[] bs = baos.toByteArray();		String encoded = Base64.encodeToString(bs, Base64.DEFAULT);		return encoded;	}	public static Bitmap bitmapFromBase64(String base64) {		byte[] decodedByte = Base64.decode(base64, Base64.DEFAULT);		return BitmapFactory.decodeByteArray(decodedByte, Base64.DEFAULT, decodedByte.length);	}	public static String bitmapSave(Bitmap bitmap, File file) {		try {			FileOutputStream stream = new FileOutputStream(file.toString()); // + ".png");			bitmap.compress(CompressFormat.PNG, 100, stream);			stream.flush();			stream.close();		} catch (Exception ex) {			ex(ex);		}		return file.getName() + ".png";	}		public static String getDeviceSerial() {		String manufacturer = Build.MANUFACTURER;		String model = Build.SERIAL;				String s = model.startsWith(manufacturer) ? model : manufacturer + " " + model;		if (s == null || s.length() == 0) {			return "";		}		char first = s.charAt(0);		if (Character.isUpperCase(first)) {			return s;		} else {			return Character.toUpperCase(first) + s.substring(1);		}	}		public static void showToast(int resId) {		Toast.makeText(at, resId, Toast.LENGTH_SHORT).show();	}	public static void showToast(String msg) {		Toast.makeText(at, msg, Toast.LENGTH_SHORT).show();	}	private static boolean backExit;	public static boolean showBackExit() {		if (backExit)			return true;		backExit = true;		Toast.makeText(at, "Please click BACK again to exit", Toast.LENGTH_SHORT).show();		new Handler().postDelayed(new Runnable() {			@Override			public void run() {				backExit = false;			}		}, 2000);		return false;	}	public static void keyboardHide(Activity at) {		keyboardHide(at.getCurrentFocus()); 	}	public static void keyboardHide(View view) {		InputMethodManager imm = (InputMethodManager) view.getContext().getSystemService(Context.INPUT_METHOD_SERVICE);		imm.hideSoftInputFromWindow(view.getWindowToken(), 0);	}	public static boolean mRequire;	public static void requireBtn(final Button btn, final Runnable runnable) {		btn.setOnClickListener(new OnClickListener() {			@Override			public void onClick(View v) {				mRequire = false;				runnable.run();			}		});	}		public static String requireTxt(EditText txt, int msgID) {		String str = txt.getText().toString().trim();				if (mRequire) {			return str;		}		if (str.equals("")) {			showToast(msgID);			txt.requestFocus();			mRequire = true;		} else {			str = (str.contains("-") ? str.replace("-", "") : str);			mRequire = false;		}		return str;	}		public static String md5(String password) {		try {			MessageDigest md = MessageDigest.getInstance("MD5");			md.update(password.getBytes());			byte byteData[] = md.digest();			StringBuffer sb = new StringBuffer();			for (int i = 0; i < byteData.length; i++)				sb.append(Integer.toString((byteData[i] & 0xff) + 0x100, 16).substring(1));			return sb.toString();		} catch (Exception ex) {			ex(ex);			mRequire = true;			return "";		}	}		public static class DialogHelper {				public static AlertDialog get(int titleId, int messageId, View view, final Runnable runnable) {			AlertDialog.Builder builder = new AlertDialog.Builder(at);			if (titleId != 0)				builder.setTitle(titleId);			if (messageId != 0)				builder.setMessage(messageId);			if (view != null)				builder.setView(view);			builder.setPositiveButton(android.R.string.yes, new DialogInterface.OnClickListener() {				@Override				public void onClick(DialogInterface dialog, int which) {					if (runnable != null)						runnable.run();				}			});			builder.setNegativeButton(android.R.string.no, null);			builder.setCancelable(false);			final AlertDialog alertDialog = builder.create();			alertDialog.show();			return alertDialog;		}				public static void view(int title, final View view, final Runnable runnable) {			AlertDialog.Builder builder = new AlertDialog.Builder(at);			if (title != 0)				builder.setTitle(title);			builder.setView(view);			if (runnable != null) {				builder.setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {					@Override					public void onClick(DialogInterface dialog, int which) {						keyboardHide(view);						runnable.run();					}				});				builder.setNegativeButton(android.R.string.cancel, new DialogInterface.OnClickListener() {										@Override					public void onClick(DialogInterface dialog, int which) {						keyboardHide(view);					}				});			} else {				builder.setPositiveButton(android.R.string.ok, null);			}			builder.show();		}		public static void confirm(int title, String message, final Runnable runnable) {			AlertDialog.Builder builder = new AlertDialog.Builder(at);			builder.setTitle(title);			builder.setMessage(message);			builder.setPositiveButton(android.R.string.yes, new DialogInterface.OnClickListener() {				@Override				public void onClick(DialogInterface dialog, int which) {					runnable.run();				}			});			builder.setNegativeButton(android.R.string.no, null);			builder.create();			builder.show();		}		public static void pickerDate(final Button btn, final Runnable runnable) {			final OnDateSetListener callBack = new OnDateSetListener() {				@Override				public void onDateSet(DatePicker view, int y, int m, int d) {					Calendar calendar = Calendar.getInstance();					calendar.set(y, m, d);					btn.setText(BHelper.CalendarHelper.getDate(calendar));					if (runnable != null)						runnable.run();				}			};			btn.setOnClickListener(new OnClickListener() {				@Override				public void onClick(View v) {					Calendar calendar = BHelper.CalendarHelper.getCalendar(btn.getText().toString().trim());					int year = calendar.get(Calendar.YEAR);					int monthOfYear = calendar.get(Calendar.MONTH);					int dayOfMonth = calendar.get(Calendar.DAY_OF_MONTH);					new DatePickerDialog(at, callBack, year, monthOfYear, dayOfMonth).show();				}			});		}		public static void pickerTime(final Button btn, final Runnable runnable) {			final OnTimeSetListener callBack = new OnTimeSetListener() {				@Override				public void onTimeSet(TimePicker view, int h, int m) {					Calendar calendar = Calendar.getInstance();					calendar.set(Calendar.HOUR_OF_DAY, h);					calendar.set(Calendar.MINUTE, m);					btn.setText(BHelper.CalendarHelper.getTime(calendar));					if (runnable != null)						runnable.run();				}			};			btn.setOnClickListener(new OnClickListener() {				@Override				public void onClick(View v) {					final Calendar calendar = BHelper.CalendarHelper.getCalendar(btn.getText().toString().trim());					int hourOfDay = calendar.get(Calendar.HOUR_OF_DAY);					int minute = calendar.get(Calendar.MINUTE);					new TimePickerDialog(at, callBack, hourOfDay, minute, true).show();				}			});		}	}		@SuppressLint("SimpleDateFormat")	public static class CalendarHelper {		private static final String			mDateTime = "yyyy-MM-dd HH:mm:ss.SSS",			mDate = "yyyy-MM-dd",			mTime = "HH:mm";		public static Calendar getCalendar(String str) {			str = str.replace("T", " ");			Calendar calendar = Calendar.getInstance();			try {				int start = str.substring(2, 3).equals(":") ? 11 : 0;				String formatString = mDateTime.substring(start, start + str.length());				calendar.setTime(new SimpleDateFormat(formatString).parse(str));			} catch (Exception ex) {				ex(ex);			}			return calendar;		}		public static String getDateTime(Calendar calendar) {			calendar = (calendar != null) ? calendar : Calendar.getInstance();			return new SimpleDateFormat(mDateTime).format(calendar.getTime());		}		public static String getDate(Calendar calendar) {			return new SimpleDateFormat(mDate).format(calendar.getTime());		}		public static String getTime(Calendar calendar) {			return new SimpleDateFormat(mTime).format(calendar.getTime());		}		public static String getZero(String str) {			String result = "";			int length = str.length();			length = length > 2 ? 4 : 2;			for (int i = str.length(); i < length; i++)				result += "0";			return result + str;		}	}	public static boolean isPackageInstalled(String packagename, Context context) {	    PackageManager pm = context.getPackageManager();	    try {	        pm.getPackageInfo(packagename, PackageManager.GET_ACTIVITIES);	        db("existed:"+packagename);	        return true;	    } catch (NameNotFoundException e) {	        return false;	    }	}}